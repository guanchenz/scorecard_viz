<!DOCTYPE html>
<html>

<head>
  <script src="shared/jquery.js" type="text/javascript"></script>
  <!-- <script   src="https://code.jquery.com/jquery-3.2.1.slim.min.js"   integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="   crossorigin="anonymous"></script> -->
  <script src="shared/shiny.js" type="text/javascript"></script>
  <!-- <script src="shinyjs/inject.js"></script> -->
  <link rel="stylesheet" type="text/css" href="shared/shiny.css"/>

  <!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->

  <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
  <script src="/datamaps.usa.min.js"></script> -->

  <style>

      .background {
        fill: none;
        pointer-events: all;
      }

      .feature {
        fill: #ccc;
        cursor: pointer;
      }

      .feature.active {
        fill: orange;
      }

      .mesh {
        fill: none;
        stroke: #fff;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

  </style>
</head>

<body>

  <script src="//d3js.org/d3.v4.min.js"></script>
  <script src="//d3js.org/topojson.v1.min.js"></script>

  <h1>Scorecard</h1>

  <pre id="someText" class="shiny-text-output"></pre>
  <!-- <p>
    <label>Distribution type:</label><br />
    <select name="dist">
      <option value="norm">Normal</option>
      <option value="unif">Uniform</option>
      <option value="lnorm">Log-normal</option>
      <option value="exp">Exponential</option>
    </select>
  </p>

  <p>

    <label>Number of observations:</label><br />
    <input type="number" name="n" value="500" min="1" max="1000" />

  </p>

  <h3>Summary of data:</h3>
  <pre id="summary" class="shiny-text-output"></pre>

  <h3>Plot of data:</h3>
  <div id="plot" class="shiny-plot-output"
       style="width: 100%; height: 300px"></div>

  <h3>Head of data:</h3>
  <div id="table" class="shiny-html-output"></div> -->

  <!-- <div id="container" name="map" style="position: relative; width: 500px; height: 300px;"></div>
  <input id="inputState" name="state" value="" disabled />
  <script>
      var map = new Datamap({
          element: document.getElementById('container'),
          scope: 'usa',
          fills: {
              HIGH: '#afafaf',
              LOW: '#123456',
              MEDIUM: 'blue',
              UNKNOWN: 'rgb(0,0,0)',
              defaultFill: 'green'
          },
          data: {
              IRL: {
                  fillKey: 'LOW',
                  numberOfThings: 2002
              },
              USA: {
                  fillKey: 'MEDIUM',
                  numberOfThings: 10381
              }
          },
          done: function(datamap) {
              datamap.svg.selectAll('.datamaps-subunit').on('click', function(geography) {
                  $('#inputState').val(geography.properties.name);
                  // alert(geography.properties.name);
              });
          }
      });

      // map.legend();
  </script> -->

  <input id="inputState" name="state" value="" disabled />

  <input id="selected" name="selected" type="text" value="">

  <button id="search-state">search</button>

  <script>
      // const URL = "https://gist.githubusercontent.com/mbostock/4090846/raw/d534aba169207548a8a3d670c9c2cc719ff05c47/us.json";
      // const URL_STATES = "https://gist.githubusercontent.com/mbostock/4090846/raw/07e73f3c2d21558489604a0bc434b3a5cf41a867/us-state-names.tsv";
      const URL = "./data/us.json";
      const URL_STATES = "./data/us-state-names.tsv";
      var width = 960,
      height = 500,
      active = d3.select(null);

      var projection = d3.geoAlbersUsa()
          .scale(1000)
          .translate([width / 2, height / 2]);

      var path = d3.geoPath()
          .projection(projection);

      var svg = d3.select("body").append("svg")
          .attr("width", width)
          .attr("height", height);

      svg.append("rect")
          .attr("class", "background")
          .attr("width", width)
          .attr("height", height)
          .on("click", reset);

      var g = svg.append("g")
      .style("stroke-width", "1.5px");

      var stateCodes = {},
          statesLookup;

      d3.json(URL, function(error, us) {
          if (error) throw error;

          var data = topojson.feature(us, us.objects.states).features;

          d3.tsv(URL_STATES, function(states) {
            statesLookup = states;
            states.forEach(function(state) {
              stateCodes[state.id] = state.code
            })

            g.selectAll("path")
              .data(data)
            .enter().append("path")
              .attr("d", path)
              .attr("class", "feature")
              .attr("id", function(d, i) { return d.id; })
              .on("click", function (d, se) {
                  // if (se) { console.log(se) }
                  console.log("Clicked", stateCodes[d.id]);
                  if (active.node() === this) return reset();
                  active.classed("active", false);
                  active = d3.select(this).classed("active", true);

                  var bounds = path.bounds(d),
                    dx = bounds[1][0] - bounds[0][0],
                    dy = bounds[1][1] - bounds[0][1],
                    x = (bounds[0][0] + bounds[1][0]) / 2,
                    y = (bounds[0][1] + bounds[1][1]) / 2,
                    scale = .9 / Math.max(dx / width, dy / height),
                    translate = [width / 2 - scale * x, height / 2 - scale * y];

                  g.transition()
                    .duration(750)
                    .style("stroke-width", 1.5 / scale + "px")
                    .attr("transform", "translate(" + translate + ")scale(" + scale + ")");

                  $('#inputState').val(stateCodes[d.id]);

                  Shiny.onInputChange("selectedState", stateCodes[d.id]);
              });

            g.append("path")
              .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
              .attr("class", "mesh")
              .attr("d", path);

            // g.append("g")
            //   .attr("class", "states-names")
            g.selectAll("text")
              .data(data)
              .enter()
              .append("svg:text")
              .text(function(d){
                return stateCodes[d.id];
              })
              .attr("x", function(d){
                  return path.centroid(d)[0];
              })
              .attr("y", function(d){
                  return  path.centroid(d)[1];
              })
              .attr("text-anchor","middle")
              .attr('fill', 'white');
        })
      });

      function clicked(d, stateSearch) {
          if (stateSearch) { console.log(stateSearch) };
          console.log("Clicked", stateCodes[d.id]);
          if (active.node() === this) return reset();
          active.classed("active", false);
          active = d3.select(this).classed("active", true);

          var bounds = path.bounds(d),
            dx = bounds[1][0] - bounds[0][0],
            dy = bounds[1][1] - bounds[0][1],
            x = (bounds[0][0] + bounds[1][0]) / 2,
            y = (bounds[0][1] + bounds[1][1]) / 2,
            scale = .9 / Math.max(dx / width, dy / height),
            translate = [width / 2 - scale * x, height / 2 - scale * y];

          g.transition()
            .duration(750)
            .style("stroke-width", 1.5 / scale + "px")
            .attr("transform", "translate(" + translate + ")scale(" + scale + ")");

          $('#inputState').val(stateCodes[d.id]);

          Shiny.onInputChange("selectedState", stateCodes[d.id]);
      }

      function reset() {
      active.classed("active", false);
      active = d3.select(null);

      g.transition()
        .duration(750)
        .style("stroke-width", "1.5px")
        .attr("transform", "");
      }
      // function onChangeInput() {
      //   var state = $('#selected').val();
      //   Shiny.onInputChange("selected", state);
      // }

  </script>

  <script>
      $(document).ready(function () {
        // $('#selected').on('input',function(e){
        //     e.preventDefault();
        //     var state = $('#selected').val();
        //
        //     // d3.selectAll("path").node().dispatchEvent("click");
        //
        //     Shiny.onInputChange("selected", state);
        // });

        $("#search-state").click(function(e) {
            // e.preventDefault();
            console.log('clicked submit')
            var sc = $('#selected').val();
            if (sc == 'CA') {
                // g.selectAll("path").each(function(d) {
                //   console.log(this);
                // })
                var id = statesLookup.filter((s) => {
                  return s.code === sc;
                })
                console.log(id);
                $('#inputState').val(id[0]['code']);
                g.select(`path[id = "${id[0]['id']}"]`).dispatch("click", {sc});

                // Shiny.onInputChange("selectedState", id[0]['code']);
            }
        });
      });
  </script>

</body>
</html>
