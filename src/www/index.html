<!DOCTYPE html>
<html>

<head>
  <script src="shared/jquery.js" type="text/javascript"></script>
  <!-- <script   src="https://code.jquery.com/jquery-3.2.1.slim.min.js"   integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="   crossorigin="anonymous"></script> -->
  <script src="shared/shiny.js" type="text/javascript"></script>
  <!-- <script src="shinyjs/inject.js"></script> -->
  <link rel="stylesheet" type="text/css" href="shared/shiny.css" />
  <link rel="stylesheet" type="text/css" href="index.css" />
</head>

<body>

  <script src="//d3js.org/d3.v4.min.js"></script>
  <script src="//d3js.org/topojson.v1.min.js"></script>

  <div class="root">
    <div class='header'>
      <h1>Scorecard Visualizer</h1>
    </div>

    <div class="map" id="map-container">

      <input id="inputState" name="state" value="" disabled />

      <!-- <input id="selected" name="selected" type="text" value="">

      <button id="search-state">search</button> -->
      <p style='margin-top: 0'>Select a college or state to get started</p>

      <div id="map-svg">
        <svg id="map"></svg>
      </div>
    </div>

    <div class="charts" id="charts-container">
      <!-- <svg id="line-chart"></svg> -->
      <div id="title">
        {{ title }}
        <hr />
      </div>

      <div class="chart-1">
        {{ plot }}
      </div>

      <div class="chart-2">
        {{ plotCost }}
      </div>

      <div class="chart-3">
        {{ plotIncome }}
      </div>

      <div class="chart-4">
        {{ plotCulture }}
      </div>
    </div>

  </div>

  <script>
      var stateCodes = {},
          statesLookup,
          cities,
          g,
          dataCollege;

      function getCities(dataFromR) {
        // console.log(dataFromR);
        dataCollege = dataFromR.INSTNM.map((d, idx) => (
          {
            coords: [dataFromR.lon[idx], dataFromR.lat[idx]],
            name: d,
            mnEarn10: dataFromR.mn_earn_wne_p10[idx],
            mnEarn9: dataFromR.mn_earn_wne_p9[idx],
            mnEarn8: dataFromR.mn_earn_wne_p8[idx],
            mnEarn7: dataFromR.mn_earn_wne_p7[idx],
            mnEarn6: dataFromR.mn_earn_wne_p6[idx]
          }
        ))
        // console.log(dataCollege);
        // const URL = "https://gist.githubusercontent.com/mbostock/4090846/raw/d534aba169207548a8a3d670c9c2cc719ff05c47/us.json";
        // const URL_STATES = "https://gist.githubusercontent.com/mbostock/4090846/raw/07e73f3c2d21558489604a0bc434b3a5cf41a867/us-state-names.tsv";
        const URL = "./data/us.json";
        const URL_STATES = "./data/us-state-names.tsv";
        // var width = 960,
        // height = 500;
        var width = document.getElementById('map-container').offsetWidth;
        var height = document.getElementById('map-container').offsetHeight;
        var active = d3.select(null);
        // console.log(width, height)

        var projection = d3.geoAlbersUsa()
            .scale(800)
            .translate([width / 2, height / 2]);

        var path = d3.geoPath()
            .projection(projection);

        var svg = d3.select("#map")
            .attr("width", width)
            .attr("height", height);

        svg.append("rect")
            .attr("class", "background")
            .attr("width", width)
            .attr("height", height)
            .on("click", reset);

        g = svg.append("g")
        .style("stroke-width", "1.5px");

        // for tooltip
        var div = d3.select("body")
  		    .append("div")
      		.attr("class", "tooltip")
      		.style("opacity", 0);


        d3.json(URL, function(error, us) {
            if (error) throw error;

            var data = topojson.feature(us, us.objects.states).features;

            d3.tsv(URL_STATES, function(states) {
              statesLookup = states;
              states.forEach(function(state) {
                stateCodes[state.id] = state.code
              })

              g.selectAll("path")
                .data(data)
              .enter().append("path")
                .attr("d", path)
                .attr("class", "feature")
                .attr("id", function(d, i) { return d.id; })
                .on("click", function (d, se) {
                    // if (se) { console.log(se) }
                    // console.log("Clicked", stateCodes[d.id]);
                    if (active.node() === this) return reset();
                    active.classed("active", false);
                    active = d3.select(this).classed("active", true);

                    var bounds = path.bounds(d),
                      dx = bounds[1][0] - bounds[0][0],
                      dy = bounds[1][1] - bounds[0][1],
                      x = (bounds[0][0] + bounds[1][0]) / 2,
                      y = (bounds[0][1] + bounds[1][1]) / 2,
                      scale = .9 / Math.max(dx / width, dy / height) / 1.5,
                      translate = [width / 2 - scale * x, height / 2 - scale * y];

                    g.transition()
                      .duration(750)
                      .style("stroke-width", 1.5 / scale + "px")
                      .attr("transform", "translate(" + translate + ")scale(" + scale + ")");

                    $('#inputState').val(stateCodes[d.id]);

                    Shiny.onInputChange("selectedState", stateCodes[d.id]);
                });

              g.append("path")
                .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
                .attr("class", "mesh")
                .attr("d", path);

              // g.append("g")
              //   .attr("class", "states-names")
              g.selectAll("text")
                .data(data)
                .enter()
                .append("svg:text")
                .text(function(d){
                  return stateCodes[d.id];
                })
                .attr("x", function(d){
                    return (path.centroid(d)[0]) ? path.centroid(d)[0] : null;
                })
                .attr("y", function(d){
                    return  (path.centroid(d)[1]) ? path.centroid(d)[1] : null;
                })
                .attr("text-anchor","middle")
                .attr('fill', 'white');

              g.selectAll("circle")
                .data(dataCollege)
                .enter()
                .append("circle")
                .attr("cx", function(d) {
                  return (projection(d.coords)) ? projection(d.coords)[0] : null;
                })
                .attr("cy", function(d) {
                  return (projection(d.coords)) ? projection(d.coords)[1] : null;
                })
                .attr("r", function(d) {
                  return 2;
                })
                  .style("fill", "rgb(217,91,67)")
                  .style("opacity", 0.85)
                  .on("mouseover", function(d) {
                  	div.transition()
                    	   .duration(100)
                         .style("opacity", .9)
                         .style("display", 'inline-block');
                         div.text(d.name)
                         .style("left", (d3.event.pageX) + "px")
                         .style("top", (d3.event.pageY - 28) + "px");
              	    })
                  .on("mouseout", function (d) {
                    div.transition()
                      .duration(0)
                      .style("display", 'none')
                  })
                  .on("click", onClickCircle)


              // *************** line chart ******************
              var margin = {top: 20, right: 20, bottom: 30, left: 50};

              var widthLineChart = document.getElementById('charts-container').offsetWidth;
              var heightLineChart = document.getElementById('charts-container').offsetHeight;

              widthLineChart = widthLineChart - margin.left - margin.right;
              heightLineChart = heightLineChart - margin.top - margin.bottom;

              var svgLine = d3.select("#line-chart")
                .attr("width", widthLineChart + margin.left + margin.right)
                .attr("height", heightLineChart + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                      "translate(" + margin.left + "," + margin.top + ")");
              // var gLine = svgLine.append("g")

              var parseTime = d3.timeParse("%Y");

              var xLine = d3.scaleTime().range([0, widthLineChart]);
              var yLine = d3.scaleLinear().range([heightLineChart, 0]);

              var line = d3.line()
                  // .curve(d3.curveBasis)
                  .x(function(d) { return xLine(d.x); })
                  .y(function(d) { return yLine(d.y); });

              var colnames = ['mnEarn6', 'mnEarn7', 'mnEarn8', 'mnEarn9', 'mnEarn10'];

              var lineData = [];
              dataCollege.forEach((dat) => {
                colnames.forEach((name, idx) => {
                  lineData.push({
                    x: idx + 2012,
                    y: dat[name]
                  })
                })
              })
              // var lineData = [
              //   { x: 2006, y: 1000 },
              //   { x: 2008, y: 1500 },
              //   { x: 2010, y: 500 }
              // ];

              // line chart
              lineData.forEach(function(d) {
                d.x = parseTime(d.x);
                d.y = +d.y;
              })

              xLine.domain(d3.extent(lineData, function(d) { return d.x; }));
              yLine.domain([
                d3.min(lineData, function(d) {
                  return d.y;
                }),
                d3.max(lineData, function(d) {
                return d.y;
              })]);

              svgLine.append("g")
                .attr("transform", "translate(0," + heightLineChart + ")")
                .call(d3.axisBottom(xLine).ticks(d3.timeYear.every(1)));

              svgLine.append("g")
                .call(d3.axisLeft(yLine))

              // svgLine.append("text")
              //   .attr("transform",
              //         "translate(" + (widthLineChart/2) + " ," +
              //                        (heightLineChart + margin.top + 20) + ")")
              //   .style("text-anchor", "middle")
              //   .text("Year");

              svgLine.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x",0 - (heightLineChart / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Dollar");

              svgLine.append("path")
                .data([lineData])
                .attr("class", "line")
                // .attr("d", function(d) { return line(d); })
                .attr("d", line)
                .style("stroke", 2);

          })

        });

        function clicked(d, stateSearch) {
            if (stateSearch) { console.log(stateSearch) };
            console.log("Clicked", stateCodes[d.id]);
            if (active.node() === this) return reset();
            active.classed("active", false);
            active = d3.select(this).classed("active", true);

            var bounds = path.bounds(d),
              dx = bounds[1][0] - bounds[0][0],
              dy = bounds[1][1] - bounds[0][1],
              x = (bounds[0][0] + bounds[1][0]) / 2,
              y = (bounds[0][1] + bounds[1][1]) / 2,
              scale = .9 / Math.max(dx / width, dy / height),
              translate = [width / 2 - scale * x, height / 2 - scale * y];

            g.transition()
              .duration(750)
              .style("stroke-width", 1.5 / scale + "px")
              .attr("transform", "translate(" + translate + ")scale(" + scale + ")");

            $('#inputState').val(stateCodes[d.id]);

            Shiny.onInputChange("selectedState", stateCodes[d.id]);
        }

        function reset() {
            active.classed("active", false);
            active = d3.select(null);

            g.transition()
              .duration(750)
              .style("stroke-width", "1.5px")
              .attr("transform", "");

            Shiny.onInputChange("selectedState", null);
        }
        // function onChangeInput() {
        //   var state = $('#selected').val();
        //   Shiny.onInputChange("selected", state);
        // }
        // function getCities(locations) {
        //   console.log(locations);
        //   cities = locations;
        //   if (cities !== null) {
        //     console.log('populating cities');
        //     popCircles(locations)
        //   }
        // }

        function onClickCircle(d) {
          Shiny.onInputChange("selectedCollege", d.name);
        }

      } // end of getCities

      function updateData(dat) {
        var dataCollege = dat.INSTNM.map((d, idx) => (
          {
            coords: [dat.lon[idx], dat.lat[idx]],
            name: d,
            mnEarn10: dat.mn_earn_wne_p10[idx],
            mnEarn9: dat.mn_earn_wne_p9[idx],
            mnEarn8: dat.mn_earn_wne_p8[idx],
            mnEarn7: dat.mn_earn_wne_p7[idx],
            mnEarn6: dat.mn_earn_wne_p6[idx]
          }
        ))

        // *************** line chart ******************
        var margin = {top: 20, right: 20, bottom: 30, left: 50};

        var widthLineChart = document.getElementById('charts-container').offsetWidth;
        var heightLineChart = document.getElementById('charts-container').offsetHeight;

        widthLineChart = widthLineChart - margin.left - margin.right;
        heightLineChart = heightLineChart - margin.top - margin.bottom;

        var svgLine = d3.select("#line-chart").transition()
          .attr("width", widthLineChart + margin.left + margin.right)
          .attr("height", heightLineChart + margin.top + margin.bottom)
          .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");
        // var gLine = svgLine.append("g")

        var parseTime = d3.timeParse("%Y");

        var xLine = d3.scaleTime().range([0, widthLineChart]);
        var yLine = d3.scaleLinear().range([heightLineChart, 0]);

        var line = d3.line()
            // .curve(d3.curveBasis)
            .x(function(d) { return xLine(d.x); })
            .y(function(d) { return yLine(d.y); });

        var colnames = ['mnEarn6', 'mnEarn7', 'mnEarn8', 'mnEarn9', 'mnEarn10'];

        var lineData = [];
        dataCollege.forEach((dat) => {
          colnames.forEach((name, idx) => {
            lineData.push({
              x: idx + 2012,
              y: dat[name]
            })
          })
        })
        // var lineData = [
        //   { x: 2006, y: 1000 },
        //   { x: 2008, y: 1500 },
        //   { x: 2010, y: 500 }
        // ];

        // line chart
        lineData.forEach(function(d) {
          d.x = parseTime(d.x);
          d.y = +d.y;
        })

        xLine.domain(d3.extent(lineData, function(d) { return d.x; }));
        yLine.domain([
          d3.min(lineData, function(d) {
            return d.y;
          }),
          d3.max(lineData, function(d) {
          return d.y;
        })]);

        svgLine.append("g")
          .attr("transform", "translate(0," + heightLineChart + ")")
          .call(d3.axisBottom(xLine).ticks(d3.timeYear.every(1)));

        svgLine.append("g")
          .call(d3.axisLeft(yLine))

        // svgLine.append("text")
        //   .attr("transform",
        //         "translate(" + (widthLineChart/2) + " ," +
        //                        (heightLineChart + margin.top + 20) + ")")
        //   .style("text-anchor", "middle")
        //   .text("Year");

        svgLine.append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 0 - margin.left)
          .attr("x",0 - (heightLineChart / 2))
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .text("Dollar");

        svgLine.append("path")
          .data([lineData])
          .attr("class", "line")
          // .attr("d", function(d) { return line(d); })
          .attr("d", line)
          .style("stroke", 2);
      }

  </script>

  <script>
      $(document).ready(function () {
        // $('#selected').on('input',function(e){
        //     e.preventDefault();
        //     var state = $('#selected').val();
        //
        //     // d3.selectAll("path").node().dispatchEvent("click");
        //
        //     Shiny.onInputChange("selected", state);
        // });

        $("#search-state").click(function(e) {
            // e.preventDefault();
            console.log('clicked submit')
            var sc = $('#selected').val();
            // if (sc == 'CA') {
                // g.selectAll("path").each(function(d) {
                //   console.log(this);
                // })
                var id = statesLookup.filter((s) => {
                  return s.code === sc;
                })
                console.log(id);
                $('#inputState').val(id[0]['code']);
                g.select(`path[id = "${id[0]['id']}"]`).dispatch("click", {sc});

                // Shiny.onInputChange("selectedState", id[0]['code']);
            // }
        });

        Shiny.addCustomMessageHandler("getCities", getCities);
        Shiny.addCustomMessageHandler("updateData", updateData);
      });
  </script>

</body>
</html>
